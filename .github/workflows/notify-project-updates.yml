#.github/workflows/notify-project-updates.yml
name: Notify GitHub Project Updates to Slack
on:
  issues:
    types: [opened, edited, reopened, closed]
  project_v2_item:
    types: [edited, created, deleted]
jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Build message
        id: message
        run: |
          # åˆæœŸå€¤
          MSG=""
          # ==== ã‚¤ã‚·ãƒ¥ãƒ¼é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆ ====
          if [ "${{ github.event_name }}" = "issues" ]; then
            ACTION="${{ github.event.action }}"
            TITLE="${{ github.event.issue.title }}"
            URL="${{ github.event.issue.html_url }}"
            ACTOR="${{ github.actor }}"
            MSG="âœï¸ *${ACTOR}* ãŒ Issue *${TITLE}* ã‚’ ${ACTION} ã—ã¾ã—ãŸã€‚\n${URL}"
          # ==== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒ‰ã®ã‚¢ã‚¤ãƒ†ãƒ æ›´æ–° ====
          elif [ "${{ github.event_name }}" = "project_v2_item" ]; then
            ACTION="${{ github.event.action }}"
            PROJECT="${{ github.event.project_v2_item.project_node.name }}"
            ACTOR="${{ github.actor }}"
            
            # åˆ—ã®ç§»å‹•ãŒã‚ã£ãŸã‹ç¢ºèª
            FROM=$(echo '${{ toJson(github.event.changes.field_value_nodes.from) }}' | jq -r '.[0].name? // empty')
            TO=$(echo '${{ toJson(github.event.project_v2_item.field_value_nodes) }}' | jq -r '.[0].name? // empty')
            TITLE=$(echo '${{ github.event.project_v2_item.content.title }}' | jq -r '.' )
            URL=$(echo '${{ github.event.project_v2_item.content.url }}' | jq -r '.' )
            if [ "$FROM" != "" ] && [ "$TO" != "" ]; then
              MSG="ğŸ“‹ *${ACTOR}* ãŒ Project *${PROJECT}* ã®ã‚«ãƒ¼ãƒ‰ *${TITLE}* ã‚’ \`${FROM}\` â†’ \`${TO}\` ã«ç§»å‹•ã—ã¾ã—ãŸã€‚\n${URL}"
            else
              MSG="ğŸ“‹ *${ACTOR}* ãŒ Project *${PROJECT}* ã®ã‚«ãƒ¼ãƒ‰ *${TITLE}* ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚\n${URL}"
            fi
          fi
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Send to Slack
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "${{ steps.message.outputs.message }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
